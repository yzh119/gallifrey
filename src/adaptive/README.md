# Adaptive Polynomial Rendering
This directory contains my implementation of the *Adaptive Polynomial Rendering*(SIGGRAPH 2016, Bochang et al.) algorithm.
  
Here are my notes of this paper.

---
## Notes

This paper aims to reduce the MC noise of image generated by MCPT algorithm.

### Reconstruction Framework
The author use the following statistical model:
$$ y(i) = \mu(i) + \epsilon(i) $$
where \\(y\\) is the generated image function, \\(\mu\\) is the ground truth intensity, \\(\epsilon\\) models MC error.

More specifically, they decompose the ground truth into two functions: \\(\mu(i) \equiv g(f_i) + p(i)\\), the first function focuses on features related to 3D position while the second function focuses on pixel position.

Locally, they approximate the unknown \\(\mu\\) function by using Taylor Polynomials:
$$\mu(i) \approx \nabla g(f\_c) (f\_i - f\_c)^T + p(c) + \sum_{1\leq a \leq k} \frac{\nabla^a p(c)}{a!} ((i - c)^a)^T $$

The coefficients could be optimized by minizing the following function (using least-square method):
$$\sum\_{i\in \Omega\_c} \left( y(i) - \alpha(f\_i - f\_c)^T - \beta\_0 - \sum\_{1\leq a \leq k} \beta\_a ((i - c)^a)  \right)^2 K\_h(i)$$

After reconstruction, the output at pixel $i$ woule be:
$$\hat{y}(i) = \sum\_{j\in \Omega\_i} K\_h^j(i) \hat{y}\_k^j (i) / \sum\_{j\in \Omega_{i}} K\_h^j(i) $$
### Adaptive Polynomial Reconstruction
To locally optimize the polynomial order \\(k\\), we have to optimize the fuction:
$$ \xi\_c(k) \equiv \frac{1}{\sum K\_h(i)} \sum\_{i\in \Omega\_c} K\_h(i) (\hat{y}\_k(i) - \mu(i))^2 $$

where \\(\mu\\) is intractable, thus we need to find alternatives to optimize. 

#### Bias and Variance Expression

According to the definition of variance: \\(\sigma(X) = EX^2 - (EX)^2\\), we derive:

$$E(\hat{y}\_k(i) - \mu(i))^2 = bias^2(\hat{y}\_k(i)) + \sigma^2(\hat{y}\_k(i)) $$

where the bias and variance could be computed by the hat matrix:
$$E(\hat{y}\_k(i)) \approx \sum\_{j\in \Omega_c} H\_{ij}(k) \mu(j) - \mu(i) $$

$$\sigma^2(\hat{y}\_k(i)) \approx \sum\_{j\in \Omega^c} (H\_{ij}(k))^2 \sigma^2(y(j)) $$

then the optimal \\(k\\) could be chosen via

$$k\_{opt} = \arg\min\_k \sum\_{i\in \Omega\_c} K\_h(i) ((E(\hat{y}\_k (i) - \mu(i)))^2 + \sigma^2(\hat{y}_k(i)))  $$

in which the normalization term has been dropped out.
#### Multi-Stage Error Estimation

Directly use \\(y\\) and sample variance \\(s\\) to replace \\(mu\\) and \\(\sigma\\) will make them too noisy resulting in a noisy selection of polynomial order.

The author proposed a multi-stage way to deal with this problem, 

#### Energy-Preserving Outlier Removal

When MC renderer renders a scene includes glossy materials, the outlier (spike noise) pixels exhibit an excessive intensity. The outliers should be removed as a pre-process, making the optimization process for reconstruction more robustly.

The side effect of outlier removal is the energy loss in the reconstructed image. The author proposed an energy-preserving outlier removal technique.

If the difference between the intensity of the center pixel and the average intensity of all neighboring pixels is three times higher than the computed standard deviation, it is replaced with a pixel that has median intensity and its variance.

Energy is preserved by

$$\hat{y}(i) = \hat{y}(i) + \rho\_o \hat{y}(i) $$

where \\(\rho\\) is computed via


$$e_o = \sum\_{i\in\Omega\_o} \rho\_o \hat{y}(i)  $$

### Adaptive Polynomial Sampling
The error could be further reduced by allocating ray samples adaptively.

A weighting function: \\(K\\) is used to allocate ray samples.

---
## Details in implementation

Since linear-algebra related operations are called frequently in this paper, I use highly-optimized linear algebra library: [aramadillo](http://arma.sourceforge.net/) to achieve better performance in my CPU implementation.

## Reference

- [Adaptive sampling and reconstruction using greedy error minimization](http://dl.acm.org/citation.cfm?id=2024193)
- [Robust Image Denoising using a Virtual Flash Image for Monte Carlo Ray Tracing](http://www.ci.i.u-tokyo.ac.jp/~hachisuka/vfl.pdf)
- [Robust Denosing using Feature and Color Information](http://dx.doi.org/10.1111/cgf.12219)
- [Adaptive Rendering Based on Weighted Local Regression](http://dl.acm.org/citation.cfm?id=2641762)